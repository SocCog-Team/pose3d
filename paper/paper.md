---
title: '3D reconstruction toolbox for behavior tracked with multiple cameras'
tags:
  - 3D reconstruction
  - Multiple cameras
  - Pose extraction
  - Behavior tracking
authors:
 - name: Swathi Sheshadri
   orcid: 0000-0003-2850-107X
   affiliation: "1, 2"
 - name: Benjamin Dann
   orcid: 0000-0003-4332-0285
   affiliation: "1"
 - name: Timo Hueser
   orcid: 0000-0003-3998-4222
   affiliation: "1"
 - name: Hansjoerg Scherberger
   orcid: 0000-0001-6593-2800
   affiliation: "1, 2"
affiliations:
 - name: German Primate Center, Goettingen, Germany
   index: 1
 - name: Department of Biology and Psychology, University of Goettingen, Germany
   index: 2
date: 16 July 2019
bibliography: paper.bib
---

# Summary

Markerless tracking is a crucial experimental requirement for behavioral studies conducted in many species in different environments. A recently developed toolbox called DeepLabCut (DLC) (@Mathis2018) leverages Artificial Neural Network (ANN) based computer vision to make precise markerless tracking possible for scientific experiments. DLC uses a deep convolutional neural network, ResNet (@He2016) pre-trained on ImageNet database (@Imagenet) and adapts it to make it applicable for behavioral tracking tasks. To track complex behaviors such as grasping with object interaction in 3D, experimental setups with multiple cameras have to be developed. Development of such systems can largely benefit from a robust and easy to use camera calibration and 3D reconstruction toolbox. The current version of DLC allows 3D reconstruction from pairs of cameras only (@Nath2019). <br/>
We developed pose3d for 3D reconstruction of 2D features tracked from multiple cameras (n>=2). Our implementation of 3D reconstruction can be divided into two main steps namely stereo camera calibration and triangulation. Camera calibration refers to the estimation of intrinsic camera parameters namely focal length and optical center, extrinsic camera parameters namely the location of camera in world coordinates as well as the estimation of lens distortion coefficients. Additionally, in stereo camera calibration, one of the cameras is fixed as the primary and the position of the secondary camera with respect to the primary camera is estimated.  Typically, stereo camera calibration is performed by using checkerboard presented at varied angles to the pair of cameras being calibrated to establish the correspondence between 2D image coordinates and 3D world coordinates. Following this, camera parameters and distortion coefficients are estimated based on these correspondences. After stereo camera calibration is done for all secondary cameras with respect to a single selected primary camera, distortion in the measured 2D coordinates of the feature being tracked can be corrected and transformed into 3D world coordinates using triangulation. There exists other OpenCV (@opencv) based implementations in python particularly Anipose (@Anipose) which provide similar functionality as pose3d. However, in comparison to OpenCV based implementations, pose3d provides a user-friendly application by integrating with the feature-rich graphical user interface (GUI) for stereo camera calibration in Matlab (The MathWorks Inc., Natick, Massachusetts). A more detailed comparison between Anipose and pose3d is included in a subsequent section titled “Comparison of Anipose and pose3d”. <br/>
To use pose3d for stereo camera calibration and 3D reconstruction the users need only to edit a configuration file to enter their experiment specific details. The configuration file is extensively commented to help users through the process of editing it. Running the main function of the repository ‘main_pose3d.m’ with user’s configuration file, creates the folder structure required for stereo camera calibration and 3D reconstruction automatically. Then, pose3d launches Matlab’s stereoCameraCalibrator GUI sequentially for every pair of primary and secondary cameras to estimate the parameters of the cameras in the user’s experimental setup. The GUI first parses through checkerboard frames recorded simultaneously from the two cameras being calibrated to select frames in which checkerboard can be detected in both cameras. At this point, the user can select the number of distortion co-efficients to be estimates. If the lens used in the experiment causes higher distortion of images, 3 distortion co-efficients can be used instead of the 2 (default) by simply selecting the radio-button on the GUI corresponding to it.  After this, clicking the calibrate button on the GUI, estimates camera parameters and relative positioning of secondary camera with respect to the primary. The GUI also displays reprojection errors across calibration frames allowing users to iteratively recalibrate after removing outliers (this can be done by right-clicking on the data browser of the GUI and selecting the option remove and recalibrate). After calibration is complete, session can be saved by clicking the save as button. This procedure is then repeated for all camera pairs to be calibrated. Pose3d prompts users throughout this procedure, providing messages on the next steps to be carried out. <br/>
After calibrating all cameras in the setup with respect to the primary, 3D coordinate of the 2D feature of interest tracked across cameras is estimated by triangulation. Pose3d implements triangulation by minimizing distance of the 3D feature coordinate from the lines passing through the focal center and the image plane of all the cameras simultaneously. The function for triangulation across ‘n’ cameras is called ‘triangulate_ncams’. This function is available for users in three modes that can be selected based on prior knowledge of experimental setup. The first mode of triangulation is referred to as ‘all’ and uses data from all ‘n’ cameras that are used to track the feature in 2D. The second mode is referred to as ‘avg’ and performs triangulation over all pairs of cameras in the setup and provides the average over all pairs as the result. The third mode is referred to as ‘best-pair’ and selects the best camera pair for every time point and feature of interest for triangulation. While the first and second modes can be used for 3D reconstruction of features tracked with any software, the third mode is applicable only when tracked 2D features are associated with likelihood values which are a given when using DLC. <br/>
While stereo camera calibration can be performed trivially using Matlab’s GUI, to perform triangulation using existing functions in Matlab is non-trivial for more than two cameras. Furthermore, triangulation in pose3d is implemented fixing one of the cameras in the experimental setup as primary which is crucial to ensure data points across camera pairs are within the same coordinate system.  <br/>
In summary, pose3d provides a semi-automated 3D reconstruction workflow that takes users through the entire process of camera calibration, undistortion, triangulation as well as post processing steps such as filtering to reduce outliers. pose3d also allows users to try different pre- and post-processing parameters and visualize its effect on the accuracy of 3D reconstruction to help perform manual parameter tuning before saving final results. Furthermore, we provide two demo datasets (details of which are provided in the next paragraph) illustrating the different capabilities of pose3d that users can refer to and get a quick-view of the features included in pose3d. Given the popularity of Matlab in academia and its well documented and easy to use core functions for camera calibration, we believe this toolbox will help make 3D reconstruction of tracked 2D behavior easier for researchers to use. <br/>
# Demo datasets and error measurement in 3D reconstruction 
Demo datasets provided in pose3d were acquired by moving a Rubik’s cube on a table along different directions and by recording it simultaneously from a 5-camera tracking system. For the demos, we track the corners of the cube using DLC in the first example and manually in the second example. Manual annotations are used to mimic the usage of pose3d for any other 2D tracking software. <br/>
The key difference between the two examples is as follows. DLC, in addition to 2D tracking provides users with a likelihood value for every tracked feature that informs the users on how confident the network is about the inferred location of a particular feature of interest at any given time point. pose3d makes use of this information by applying a threshold and automatically selecting the cameras that cross this threshold for 3D reconstruction. From the 2D tracked corners we use pose3d to track corners in 3D for 1000 example frames with DLC and 20 example frames with manual annotations. Following this, we reconstruct the edges of the cube and compare it to the standard edge length of a Rubik’s cube (57 mm). In the demo data using DLC based 2D annotations, we obtain on average an error of 1.39 mm in 3D reconstructed edge lengths computed over all 12 edges of the cube across 1000 example frames.  For the demo data using manual annotations across 20 frames we obtain an average error of 1.16 mm over all 12 edges computed over 20 manually annoted frames. Furthermore, using ‘all’ mode of triangulation provided significantly better results in both our demo datasets than the other two modes of triangulation (comparison tests for the 3 modes of 3D reconstruction included in the demo functions for reference). <br/> <br/>
# Comparison of anipose and pose3d

Our Matlab implementation pose3d was inspired by the python implementation anipose. Functionally, anipose and pose3d provide users with pre- and post-processing tools for 3D reconstruction including the process of camera calibration. The main difference with pose3d is that it focuses more on providing a user-friendly 3D reconstruction interface complete with example experiment and calibration datasets and video demonstration of usage. By entering experiment details in configuration file and running a single function in Matlab namely ‘main_pose3d.m’ the user can complete the entire procedure of 3D reconstruction. Furthermore, integration of pose3d with stereoCameraCalibrator GUI in Matlab makes the task of camera calibration very easy. This allows users to estimate camera and lens distortion parameters, select outlier frames from calibration with the click of a button. Pose3d by providing detailed documentation and GUI based implementation, therefore addresses the needs of both specialist and non-specialist users. On the other hand, anipose uses OpenCV functions which can be quite difficult for non-experts to get into. For instance, with pose3d, due to its integration with Matlab’s stereoCameraCalibrator GUI, all pairs of images used for camera calibration are visualized along with their reprojection errors allowing easy identification and removal of images with larger error values. With OpenCV functions, users get error messages that are often quite technical in nature and can take longer for non-experts to perform root-cause analysis.  Lastly, with pose3d demo datasets including example calibration images are included along with codes to run 3D reconstruction on demo datasets.
Some other minor similarities and differences between anipose and pose3d are listed in the following section. First, both anipose and pose3d allow users to have the same set of calibration files across sessions or have a separate set per session. This can be decided by the user depending on if the user wants to have the same calibration files across sessions or not. This is possible in pose3d by having the same experiment path (assigned to variable exp_path) and changing only the experiment name (assigned to variable exp_name) in the configuration file. With anipose this is implemented by having a hierarchy for the selection of calibration videos placed in different folders. Second, the triangulation approach used is the same in the two packages. However, with pose3d for comparison purposes we have included 3 modes of 3D reconstruction namely 'all', 'avg' and 'best-pair'. Of these three modes 'all' corresponds to the one implemented in anipose. On our demo dataset, we have shown 'all' mode to give the lowest on average error and is the recommended mode. Third, anipose allows for camera calibration using charuco boards, checker boards or aruco boards of which it recommends the usage of charuco and checker boards. Since pose3d integrates with the camera calibration GUI from MATLAB, only checker board is used for calibration. <br/>
For further technical reading on details of triangulation for 3D reconstruction please refer to our [supporting document](Appendix.pdf) <br/>

# References


